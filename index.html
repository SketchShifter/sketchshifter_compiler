<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PDE Compiler in Browser</title>
  <style>
    canvas { border: 1px solid black; }
    textarea { width: 100%; height: 150px; }
  </style>
</head>
<body>
  <h3>PDEコード入力：</h3>
  <textarea id="pdeCode">
    import some.library.*;

    class MySketch {
      int value = 10;
      float[] data = new float[5];
  
      void doSomething(int a, float b) {
        if (a > b) {
          value = a;
        } else {
          value = (int)b;
        }
      }
    }
  
    void setup() {
      size(400, 400);
    }
  
    void draw() {
      background(200);
      ellipse(width/2, height/2, 50, 50);
    }
  </textarea>
  <br>
  <button onclick="runPDE()">実行する</button>

  <canvas id="canvas"></canvas>

  <!-- 必須：tokenizer/parser/codegen を先に読み込む -->
  <script src="tokenizer.js"></script>
  <script src="parser.js"></script>
  <script src="codegen.js"></script>

  <script>
    window.onload = runPDE;
    // Processing風API定義（必要）
    const processingAPI = `
    let ctx;
    let width = 0, height = 0;
    let fillColor = 'black';
    let strokeColor = 'black';
    let useStroke = true;
    let useFill = true;

    function size(w, h) {
      const canvas = document.getElementById("canvas");
      canvas.width = width = w;
      canvas.height = height = h;
      ctx = canvas.getContext("2d");
    }

    function background(r, g = r, b = r) {
      ctx.fillStyle = \`rgb(\${r}, \${g}, \${b})\`;
      ctx.fillRect(0, 0, width, height);
    }

    function ellipse(x, y, w, h) {
      ctx.beginPath();
      ctx.ellipse(x, y, w / 2, h / 2, 0, 0, 2 * Math.PI);
      if (useFill) {
        ctx.fillStyle = fillColor;
        ctx.fill();
      }
      if (useStroke) {
        ctx.strokeStyle = strokeColor;
        ctx.stroke();
      }
    }

    function rect(x, y, w, h) {
      if (useFill) {
        ctx.fillStyle = fillColor;
        ctx.fillRect(x, y, w, h);
      }
      if (useStroke) {
        ctx.strokeStyle = strokeColor;
        ctx.strokeRect(x, y, w, h);
      }
    }

    function line(x1, y1, x2, y2) {
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(x2, y2);
      if (useStroke) {
        ctx.strokeStyle = strokeColor;
        ctx.stroke();
      }
    }

    function fill(r, g, b) {
      fillColor = \`rgb(\${r}, \${g}, \${b})\`;
      useFill = true;
    }

    function stroke(r, g, b) {
      strokeColor = \`rgb(\${r}, \${g}, \${b})\`;
      useStroke = true;
    }

    function noFill() {
      useFill = false;
    }

    function noStroke() {
      useStroke = false;
    }
    `;

    const processingAPI2 = `
    \nsetup();\nsetInterval(() => { if (typeof draw === 'function') draw(); }, 30);
    `;

    function runPDE() {
      const code = document.getElementById("pdeCode").value;
      try {
        const tokens = tokenize(code);
        const parser = new Parser(tokens);
        const ast = parser.parseProgram();
        const jsCode = generateJavaScriptFromAST(ast);
        const fullCode = processingAPI + "\n" + jsCode + "\n" + processingAPI2;

        const script = document.createElement("script");
        script.textContent = fullCode;
        document.body.appendChild(script);
      } catch (e) {
        console.error("実行エラー：", e);
        alert("コンパイル/実行エラーがあります");
      }
    }
  </script>
</body>
</html>
